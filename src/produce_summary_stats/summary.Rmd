---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: 
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
---

## Summary
```{r}
## global, number of significant digits
digits <- 3
quantile_as_df <- function(vec,
                           probs = c(0.025, 0.25, 0.5, 0.75, 0.975)) {
  out <- data.frame(val = quantile(vec, probs), check.names = FALSE)
  out <- tibble::rownames_to_column(out, "var")
  out <- rbind(
    out,
    data.frame(var = "mu", val = mean(vec)),
    data.frame(var = "sd", val = sd(vec))
  )
  out <- tidyr::spread(out, var, val)
  signif(out, digits)
}
```
```{r}
countries_included <- readr::read_csv("countries_included_each_week.csv")
countries_included <- group_by(countries_included, week_starting) %>%
  summarise(n = n())
```

- Number of countries included in week starting 
`r countries_included$week_starting[1]` is `r countries_included$n[1]`.

- Number of countries included in week starting 
`r tail(countries_included$week_starting, 1)` is 
`r tail(countries_included$n, 1)`.


## Proportion in Credible Interval

```{r}
unwtd_pred_error <- readr::read_csv("unwtd_pred_weekly_summary.csv")
```

### In 50% CrI

```{r}

quantile_as_df(unwtd_pred_error$prop_in_50_mu) %>%
  knitr::kable()

```
### In 95% CrI

```{r}
quantile_as_df(unwtd_pred_error$prop_in_975_mu) %>%
  knitr::kable()
```

## Relative error


```{r}
quantile_as_df(unwtd_pred_error$rel_mae_mu) %>%
  knitr::kable()
```


```{r}

better_than_null <- readRDS("better_than_null.rds")
better_than_linear <- readRDS("better_than_linear.rds")

x <- sum(better_than_null$n_less_than_1) / sum(better_than_null$n_forecasts)
y <- sum(better_than_linear$n_less_than_1) / sum(better_than_linear$n_forecasts)
```

- The relative error of the model was smaller than the error a null 
model would have made in `r scales::percent(x, 0.1)` of weeks for which forecasts were
produced.

- The relative error of the model was smaller than the error a null 
model would have made in `r scales::percent(y, 0.1)` of weeks for which forecasts were
produced.


## Medium-term forecasts

```{r}
mid_forecasts_error <- readRDS("long_forecasts_error_weekly.rds")
by_strategy <- split(
  mid_forecasts_error, mid_forecasts_error$strategy
)
```
### Mean relative error

```{r}
map_dfr(
  by_strategy, function(x) {
    split(x, x$week_of_projection) %>%
      map_dfr(~ quantile_as_df(.$rel_mae), .id = "week_of_projection")
  }, .id = "strategy"
) %>% knitr::kable()

```

### Coverage probability

#### In 50% Credible Interval

```{r}

map_dfr(
  by_strategy, function(x) {
    split(x, x$week_of_projection) %>%
      map_dfr(
        ~ quantile_as_df(.$prop_in_50), .id = "week_of_projection"
      )
  }, .id = "strategy"
) %>% knitr::kable()

```
#### In 95% Credible Interval

```{r}

map_dfr(
  by_strategy, function(x) {
    split(x, x$week_of_projection) %>%
      map_dfr(
        ~ quantile_as_df(.$prop_in_975), .id = "week_of_projection"
      )
  }, .id = "strategy"
) %>% knitr::kable()

```
## Proportion of susceptible population at the end of December 2020

```{r}
observed_ps <- readRDS("ps_qntls.rds")
ps_last_day <- map_dfr(
  observed_ps, function(x) tail(x, 1), .id = "country"
)

ps_last_day <- arrange(ps_last_day, `50%`)

```

## Country with largest attack rate

```{r}
knitr::kable(head(ps_last_day, 1))
```

## Smallest attack rate

```{r}
knitr::kable(tail(ps_last_day, 1))
```
