---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: 
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
---

## Summary

```{r}
countries_included <- readr::read_csv("countries_included_each_week.csv")
countries_included <- group_by(countries_included, week_starting) %>%
  summarise(n = n())
```

- Number of countries included in week starting 
`r countries_included$week_starting[1]` is `r countries_included$n[1]`.

- Number of countries included in week starting 
`r tail(countries_included$week_starting, 1)` is 
`r tail(countries_included$n, 1)`.


## Proportion in Credible Interval

```{r}
unwtd_pred_error <- readr::read_csv("unwtd_pred_weekly_summary.csv")
x <- mean(unwtd_pred_error$prop_in_50_mu)
x_sd <- sd(unwtd_pred_error$prop_in_50_mu)

y <- mean(unwtd_pred_error$prop_in_975_mu)
y_sd <- sd(unwtd_pred_error$prop_in_975_mu)

mae <- mean(unwtd_pred_error$rel_mae_mu)
mae_sd <- sd(unwtd_pred_error$rel_mae_mu)

```

- Overall the proportion of observations in 50% CrI is
`r scales::percent(x, 0.1)`, SD: `r scales::percent(x_sd, 0.1)` .

- Overall the proportion of observations in 95% CrI is
`r scales::percent(y, 0.1)`, SD: `r scales::percent(y_sd, 0.1)`.

- Mean relative error across all countries and all weeks of 
forecasts was `r signif(mae, 3)`. SD of relative
mean error was `r signif(mae_sd, 3)`.


```{r}

better_than_null <- readRDS("better_than_null.rds")
better_than_linear <- readRDS("better_than_linear.rds")

x <- sum(better_than_null$n_less_than_1) / sum(better_than_null$n_forecasts)
y <- sum(better_than_linear$n_less_than_1) / sum(better_than_linear$n_forecasts)
```

- The relative error of the model was smaller than the error a null 
model would have made in `r scales::percent(x, 0.1)` of weeks for which forecasts were
produced.

- The relative error of the model was smaller than the error a null 
model would have made in `r scales::percent(y, 0.1)` of weeks for which forecasts were
produced.


## Medium-term forecasts

```{r}
mid_forecasts_error <- readRDS("long_forecasts_error_weekly.rds")

across_all <- group_by(mid_forecasts_error, strategy, week_of_projection) %>%
  summarise_if(is.numeric, list(mu = mean, sd = sd))  %>%
  ungroup()

```
### Mean relative error

```{r}
select(across_all, strategy, week_of_projection, rel_mae_mu) %>%
  spread(week_of_projection, rel_mae_mu) %>%
  knitr::kable()

```

### SD relative error

```{r}
select(across_all, strategy, week_of_projection, rel_mae_sd) %>%
  spread(week_of_projection, rel_mae_sd) %>%
  knitr::kable()

```

### Coverage probability

#### In 50% Credible Interval

```{r}

select(across_all, strategy, week_of_projection, prop_in_50_mu) %>%
  spread(week_of_projection, prop_in_50_mu) %>%
  knitr::kable()

```

```{r}

select(across_all, strategy, week_of_projection, prop_in_50_sd) %>%
  spread(week_of_projection, prop_in_50_sd) %>%
  knitr::kable()

```

#### In 95% Credible Interval

```{r}

select(across_all, strategy, week_of_projection, prop_in_975_mu) %>%
  spread(week_of_projection, prop_in_975_mu) %>%
  knitr::kable()

```

```{r}

select(across_all, strategy, week_of_projection, prop_in_975_sd) %>%
  spread(week_of_projection, prop_in_975_sd) %>%
  knitr::kable()

```
## Proportion of susceptible population at the end of December 2020

```{r}
observed_ps <- readRDS("ps_qntls.rds")
ps_last_day <- map_dfr(
  observed_ps, function(x) tail(x, 1), .id = "country"
)

ps_last_day <- arrange(ps_last_day, `50%`)

```

## Country with largest attack rate

```{r}
knitr::kable(head(ps_last_day, 1))
```

## Smallest attack rate

```{r}
knitr::kable(tail(ps_last_day, 1))
```
